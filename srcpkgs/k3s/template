# Template file for 'k3s'
pkgname=k3s
version=1.19.5.1
revision=1
_ver="1.19.5+k3s1"
_ver_plugins="0.8.6-k3s1"
# _traefik_* variables' values from scripts/download in source distfile
_traefik_version="1.81.0"
_traefik_file="traefik-${_traefik_version}.tgz"
create_wrksrc=yes
build_wrksrc="${pkgname}-${_ver/+/-}"
build_style=go
go_import_path="github.com/k3s-io/k3s"
hostmakedepends="git pkg-config"
makedepends="libseccomp-devel"
depends="ipset conntrack-tools"
short_desc="Lightweight Kubernetes"
maintainer="Cameron Nemo <cnemo@tutanota.com>"
license="Apache-2.0"
homepage="https://k3s.io"
distfiles="https://${go_import_path}/archive/v${_ver}.tar.gz
 https://github.com/rancher/plugins/archive/v${_ver_plugins}.tar.gz
 https://kubernetes-charts.storage.googleapis.com/${_traefik_file}"
checksum="899b99091672ea83d5a53745b1923b14d784bc4597b85efdf3095136d153d17f
 7385060c6c74d7b1d8c718a8ceb946099cc8f62d085d421b91bb75b025d704ab
 29361e194ebb07ac8a67f2560c70247475d23e49ff59351ea011e24de5fb17ab"
skip_extraction="${_traefik_file}"

# scripts/version.sh can use CI variable values when not in a git repo
export DRONE_TAG="v${_ver}"
export DRONE_COMMIT=2532c10faad43e2b6e728fdcc01662dc13d37764

post_patch() {
	# Remove -w and -s linker flags.
	#
	# Disable cgo and unset GOARCH when running go generate. (Breaks
	# execution of anything using 'go run' inside of a go:generate line.)
	#
	# Replace git clone of plugins.git with a distfile so that its
	# SHA256SUM can be verified, similar to the traefik files. Adds a go
	# clean call to the end of the subshell since `rm -rf` on
	# a GOPATH/pkg/mod directory will fail (because everything is
	# read-only).
	#
	# Nullify BIN_SUFFIX variable. This makes it needlessly hard to use
	# vinstall with binaries, so remove it.

	patch -Np0 <"${FILESDIR}/build.patch"
	patch -Np0 <"${FILESDIR}/package-cli.patch"
}

pre_build() {
	# Recreate behavior of scripts/download minus downloading
	# anything or having anything to do with busybox.
	mkdir -p etc bin build/static/charts
	cp ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_traefik_file} build/static/charts/${_traefik_file}
}

do_build() {
	scripts/build
	scripts/package-cli
}

do_install() {
	vbin dist/artifacts/k3s
	vsv k3s-server
	vsv k3s-agent
}
