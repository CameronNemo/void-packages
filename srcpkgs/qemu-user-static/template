# Template file for 'qemu-user-static'
# This package should be updated together with qemu
pkgname=qemu-user-static
version=6.0.0
revision=2
wrksrc="qemu-${version}"
build_style=configure
hostmakedepends="pkg-config automake python3 ninja"
makedepends="dtc-devel libglib-devel pixman-devel libuuid-devel"
short_desc="QEMU User-mode emulators (statically compiled)"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-or-later, LGPL-2.1-or-later"
homepage="https://www.qemu.org"
distfiles="https://wiki.qemu.org/download/qemu-${version}.tar.bz2"
checksum=7d306a03c67c0b667d21b55e1b172f5e55a9af5ee09cbd739fb2395aeca7860c

# Copied from ${wrksrc}/scripts/qemu-binfmt-conf.sh
_binfmt_archs="i386 i486 alpha arm armeb sparc sparc32plus sparc64 \
ppc ppc64 ppcle ppc64le m68k mips mipsel mipsn32 mipsn32el mips64 mips64el \
sh4 sh4eb s390x aarch64 aarch64_be hppa riscv32 riscv64 xtensa xtensaeb \
microblaze microblazeel or1k x86_64 cris"
for a in ${_binfmt_archs}; do
	binfmt_files="${binfmt_files:-}${binfmt_files:+ }qemu-${a}"
done

post_extract() {
	vsed -i 's/__u64/unsigned long/' linux-user/host/aarch64/hostdep.h
}

do_configure() {
	if [ "$CROSS_BUILD" ]; then
		_args="--cross-prefix=${XBPS_CROSS_TRIPLET}-"
		export LIBTOOL=libtool
	fi
	unset CPP

	./configure --prefix=/usr --sysconfdir=/etc --libexecdir=/usr/libexec \
		--disable-kvm --disable-vnc-png \
		--disable-virtfs --disable-fdt --disable-seccomp \
		--enable-linux-user --disable-system \
		--static ${_args}
}

do_install() {
	make DESTDIR=${DESTDIR} install
	# Install binfmt configurations
	vmkdir usr/share/binfmts
	HOST_ARCH="${XBPS_TARGET_MACHINE%-musl}" ./scripts/qemu-binfmt-conf.sh \
		--debian --qemu-path /usr/bin --qemu-suffix -static \
		--exportdir "${DESTDIR}/usr/share/binfmts"
	# Remove unneeded stuff.
	rm -rf -- "${DESTDIR}/etc" "${DESTDIR}/usr/libexec"
	for d in doc locale man qemu; do
		rm -rf -- "${DESTDIR}/usr/share/${d}"
	done
	for f in nbd io img; do
		rm -f -- "${DESTDIR}/usr/bin/qemu-${f}"
	done
}

post_install() {
	for f in ${DESTDIR}/usr/bin/*; do
		mv "${f}" "${f}-static"
	done
}
